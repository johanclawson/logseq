name: Build Windows ARM64

on:
  # Only build when version.cljs changes (upstream releases)
  push:
    branches: [master]
    paths:
      - 'src/main/frontend/version.cljs'
  workflow_dispatch:  # Allow manual trigger

jobs:
  compile-cljs:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version from version.cljs
        id: version
        run: |
          VERSION=$(grep -oP 'defonce version "\K[^"]+' src/main/frontend/version.cljs)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: 1.11.1.1413

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: yarn install

      - name: Build ClojureScript
        run: |
          yarn gulp:build
          yarn cljs:release-electron
          yarn webpack-app-build

      - name: Upload static assets
        uses: actions/upload-artifact@v4
        with:
          name: cljs-static
          path: static/

  build-windows-arm64:
    needs: compile-cljs
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download static assets
        uses: actions/download-artifact@v4
        with:
          name: cljs-static
          path: static/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies (ARM64)
        working-directory: static
        env:
          npm_config_arch: arm64
        run: |
          git config --global url."https://github.com".insteadOf ssh://git@github.com
          git config --global url."https://github.com/".insteadOf git@github.com:
          yarn install

      - name: Build Electron ARM64
        working-directory: static
        env:
          npm_config_arch: arm64
        run: yarn electron:make-win-arm64

      - name: Prepare artifacts
        run: |
          mkdir builds
          move static\out\make\squirrel.windows\arm64\*.nupkg builds\
          move static\out\make\zip\win32\arm64\*.zip builds\
          move static\out\make\wix\arm64\Logseq.msi builds\Logseq-win-arm64.msi
        shell: cmd

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: logseq-win-arm64
          path: builds/

  release:
    needs: [compile-cljs, build-windows-arm64]
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.compile-cljs.outputs.version }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: logseq-win-arm64
          path: ./

      - name: Create versioned release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}-arm64
          name: Windows ARM64 v${{ env.VERSION }}
          prerelease: false
          files: |
            *.nupkg
            *.zip
            *.msi
          body: |
            ## Windows ARM64 v${{ env.VERSION }}

            This is an unofficial Windows ARM64 build based on Logseq v${{ env.VERSION }}.

            **What works:** Core note-taking, local files, whiteboards, plugins
            **What's disabled:** Logseq Sync, Git integration (requires native ARM64 binaries)

            ### Installation
            - **MSI installer** (recommended): `Logseq-win-arm64.msi`
            - **Portable ZIP**: `Logseq-win32-arm64-*.zip`

            See [README](https://github.com/johanclawson/logseq#readme) for details.

      - name: Update latest rolling release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: win-arm64-latest
          name: Windows ARM64 Latest (v${{ env.VERSION }})
          prerelease: true
          files: |
            *.nupkg
            *.zip
            *.msi
          body: |
            ## Windows ARM64 Latest

            **Current version:** v${{ env.VERSION }}

            This rolling release always contains the latest ARM64 build.
            For a specific version, see the [versioned releases](https://github.com/johanclawson/logseq/releases).

            **What works:** Core note-taking, local files, whiteboards, plugins
            **What's disabled:** Logseq Sync, Git integration
